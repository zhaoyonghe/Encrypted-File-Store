#include "hmac.h"
#include "utils.h"
#include <string.h>
#include <stdlib.h>

// block size is 64, sha output size is 32
// we assume the input key length equals to sha output size 
void hmac(const BYTE key[], const BYTE message[], const int msg_len, BYTE buf[]) {
	BYTE opad[BLOCK_SIZE] = {
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,
		0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c,0x5c
	};

	BYTE ipad[BLOCK_SIZE] = {
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
		0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36
	};

	// we assume the input key length equals to sha output size 
	// the key is already hashed, so we do not need to do the hashing step

	// equivalant to padding on the right of the key and then xor
	xor(opad, key, SHA_OUTPUT_SIZE);
	xor(ipad, key, SHA_OUTPUT_SIZE);

	int ipad_concat_len = BLOCK_SIZE + msg_len;
	BYTE* ipad_concat = malloc(ipad_concat_len * sizeof(BYTE));
	int i = 0;
	for (int j = 0; j < BLOCK_SIZE; i++, j++) {
		ipad_concat[i] = ipad[j];
	}
	for (int j = 0; j < msg_len; i++, j++) {
		ipad_concat[i] = message[j];
	}

	SHA256_CTX ctx;
	sha256_init(&ctx);
	sha256_update(&ctx, ipad_concat, ipad_concat_len);
	sha256_final(&ctx, buf);

	int opad_concat_len = BLOCK_SIZE + SHA_OUTPUT_SIZE;
	BYTE* opad_concat = malloc(opad_concat_len * sizeof(BYTE));
	i = 0;
	for (int j = 0; j < BLOCK_SIZE; i++, j++) {
		opad_concat[i] = opad[j];
	}
	for (int j = 0; j < SHA_OUTPUT_SIZE; i++, j++) {
		opad_concat[i] = buf[j];
	}

	sha256_init(&ctx);
	sha256_update(&ctx, opad_concat, opad_concat_len);
	sha256_final(&ctx, buf);

	free(ipad_concat);
	free(opad_concat);
}